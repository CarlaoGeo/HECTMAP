<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Desenhe a √°rea</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
<style>
html, body, #map {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: 'Arial', sans-serif;
    background-color: #f5f5f5;
}

#canvas {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1500; /* acima do mapa, abaixo de menus */
    pointer-events: none;
}

.btn {
    background-color: #e0e0e0;
    padding: 10px 14px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    color: #333;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transition: all 0.2s ease;
    z-index: 2000;
}

.btn:hover {
    background-color: #d5d5d5;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

#info {
    position: absolute;
    top: 80px;
    left: 20px;
    background: #f0f0f0;
    padding: 12px 18px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: bold;
    color: #222;
    z-index: 2000;
    box-shadow: 0 3px 6px rgba(0,0,0,0.16);
}

#btnMenu {
    position: absolute;
    top: 30px;
    right: 20px;
}

#dropdownMenu {
    position: absolute;
    top: 75px;
    right: 20px;
    background: #e0e0e0;
    border-radius: 12px;
    padding: 10px;
    z-index: 2000;
    box-shadow: 0 3px 8px rgba(0,0,0,0.18);
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
    transition: all 0.25s ease;
}

#dropdownMenu.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

#dropdownMenu .btn {
    display: block;
    margin: 8px 0;
    width: 140px;
    text-align: center;
}

#btnGps {
    position: absolute;
    top: 80px;
    right: 20px;
    z-index: 1000;
}

/* Painel KML */
#kmlConfigPanel {
    display: none;
    position: absolute;
    top: 200px;
    right: 20px;
    background: #ffffff;
    padding: 15px 20px;
    border-radius: 12px;
    z-index: 3000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

#kmlConfigPanel .btn, #kmlConfigPanel input[type=color], #kmlConfigPanel input[type=checkbox] {
    margin: 6px 0;
}

/* Modal personalizado */
.custom-modal {
    position: fixed;
    top:0;
    left:0;
    width:100vw;
    height:100vh;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 6000;
}

.custom-modal-content {
    background: #dcdcdc;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    font-family: Arial, sans-serif;
    font-weight: bold;
    min-width: 250px;
    text-align: center;
}

.custom-modal button {
    background: #bfbfbf;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    margin: 5px;
    font-weight: bold;
    cursor: pointer;
}

.custom-modal input {
    width: 80%;
    padding: 5px;
    margin: 10px 0;
    border-radius: 6px;
    border: 1px solid #999;
    font-weight: bold;
}

.leaflet-control-attribution {
    font-size: 5px !important; /* Tamanho da fonte menor */
    background: rgba(255, 255, 255, 0.5) !important; /* Fundo um pouco transparente */
}
</style>
</head>
<body>
<div id="map"></div>
<canvas id="canvas"></canvas>

<div id="info">√Årea: 0 ha</div>

<!-- Bot√£o do menu -->
<div id="btnMenu" class="btn">‚ò∞ Menu</div>

<!-- Dropdown com outros bot√µes -->
<div id="dropdownMenu">
    <div id="btnDraw" class="btn">‚úèÔ∏è Desenhar</div>
    <div id="btnClear" class="btn">üóëÔ∏è Limpar</div>
    <div id="btnSave" class="btn">üíæ Salvar</div>
    <button id="btnLoadKML" class="btn">üìÇ Carregar Arquivo</button>
    <div id="btnKMLConfig" class="btn" style="display:none;">‚öôÔ∏è Configurar Camada</div>
</div>

<!-- Bot√£o GPS -->
<button id="btnGps" class="btn">üìç</button>

<input type="file" id="inputLoadKML" accept=".kml,.geojson,.json" style="display:none;" />

<div id="kmlConfigPanel">
    <label>Cor do contorno:</label>
    <input type="color" id="strokeColor" value="#ff0000"><br>
    <label>Cor do preenchimento:</label>
    <input type="color" id="fillColor" value="#ff0000"><br>
    <label><input type="checkbox" id="noFill"> Sem preenchimento</label><br>
    <button id="applyKMLStyle" class="btn">Aplicar</button>
    <button id="btnDeleteKML" class="btn">‚ùå Excluir Camada</button>
</div>

<!-- Modal salvar -->
<div id="formatModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:5000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px 30px; border-radius:10px; box-shadow:0 2px 8px #0008; min-width:220px;">
    <label for="formatSelect"><b>Escolha o formato para salvar:</b></label><br>
    <select id="formatSelect" style="margin:10px 0; padding: 5px; width:100%; border-radius: 5px;">
      <option value="kml">KML</option>
      <option value="geojson">GeoJSON</option>
      <option value="csv">CSV (Coordenadas)</option>
    </select>
    <div style="text-align:right; margin-top: 15px;">
      <button id="formatCancel" style="margin-right:10px; padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; cursor:pointer;">Cancelar</button>
      <button id="formatOk" style="padding: 8px 12px; border-radius: 5px; border: none; background-color: #4CAF50; color: white; cursor:pointer;">Salvar</button>
    </div>
  </div>
</div>

<script>
// --- Inicializa√ß√£o do mapa ---
var map = L.map('map', {
        minZoom: 2,
        maxZoom: 22
    }).setView([-22.78,-47.31], 10);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
        attribution: 'Tiles &copy; Esri &mdash; i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
        maxNativeZoom: 18,
        maxZoom: 22
    }).addTo(map);

var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
canvas.width = window.innerWidth; canvas.height = window.innerHeight;

var drawing=false, isDrawing=false, points=[];
var drawnLayer = new L.FeatureGroup(); map.addLayer(drawnLayer);
var polygonsCount = 0, maxPolygons = 3, areas = [];

// --- Bot√µes ---
var btnDraw = document.getElementById('btnDraw');
var btnClear = document.getElementById('btnClear');
var btnSave = document.getElementById('btnSave');
var btnKMLConfig = document.getElementById('btnKMLConfig');
var btnDeleteKML = document.getElementById('btnDeleteKML');
var info = document.getElementById('info');
var kmlConfigPanel = document.getElementById('kmlConfigPanel');
var strokeColorInput = document.getElementById('strokeColor');
var fillColorInput = document.getElementById('fillColor');
var noFillCheckbox = document.getElementById('noFill');
var applyBtn = document.getElementById('applyKMLStyle');
var currentLoadedLayer = null;
var inputLoadKML = document.getElementById('inputLoadKML');
var btnLoadKML = document.getElementById('btnLoadKML');
var formatModal = document.getElementById('formatModal');
var formatSelect = document.getElementById('formatSelect');
var formatOk = document.getElementById('formatOk');
var formatCancel = document.getElementById('formatCancel');
var btnGps = document.getElementById('btnGps');

// --- Dropdown menu ---
var btnMenu = document.getElementById('btnMenu');
var dropdownMenu = document.getElementById('dropdownMenu');
btnMenu.onclick = function() {
    dropdownMenu.classList.toggle('show');
};
document.addEventListener('click', function(e){
    if(!dropdownMenu.contains(e.target) && e.target !== btnMenu){
        dropdownMenu.classList.remove('show');
    }
    if(!kmlConfigPanel.contains(e.target) && e.target !== btnKMLConfig){
        kmlConfigPanel.style.display = 'none';
    }
});

// --- Desenho ---
btnDraw.onclick = function() {
    dropdownMenu.classList.remove('show');
    kmlConfigPanel.style.display = 'none';
    drawing = !drawing;
    canvas.style.pointerEvents = drawing ? 'auto' : 'none';
    
    if(drawing){
        map.dragging.disable(); map.touchZoom.disable(); map.scrollWheelZoom.disable();
        btnDraw.textContent = 'üñêÔ∏è Mover mapa';
    } else {
        map.dragging.enable(); map.touchZoom.enable(); map.scrollWheelZoom.enable();
        btnDraw.textContent = '‚úèÔ∏è Desenhar';
    }
};

btnClear.onclick = function(){
    drawnLayer.clearLayers();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    info.textContent="√Årea: 0 ha";
    polygonsCount = 0;
    areas = [];
    dropdownMenu.classList.remove('show');
};

// --- Eventos de desenho ---
function getPoint(e){ return e.touches ? [e.touches[0].clientX,e.touches[0].clientY] : [e.clientX,e.clientY]; }
function startDrawing(e){ if(!drawing) return; isDrawing=true; points=[]; ctx.clearRect(0,0,canvas.width,canvas.height); ctx.beginPath(); const [x,y]=getPoint(e); points.push([x,y]); ctx.moveTo(x,y); e.preventDefault(); }
function draw(e){ if(!drawing || !isDrawing) return; const [x,y]=getPoint(e); ctx.lineTo(x,y); ctx.strokeStyle='red'; ctx.lineWidth=2; ctx.stroke(); points.push([x,y]); e.preventDefault(); }
function endDrawing(e){
    if(!drawing || !isDrawing) return;
    isDrawing=false; if(points.length<3) return;
    if(polygonsCount >= maxPolygons){ customAlert("M√°ximo de 3 pol√≠gonos atingido."); ctx.clearRect(0,0,canvas.width,canvas.height); points=[]; drawing=false; canvas.style.pointerEvents='none'; map.dragging.enable(); map.touchZoom.enable(); map.scrollWheelZoom.enable(); btnDraw.textContent='‚úèÔ∏è Desenhar'; return; }
    const latlngs = points.map(pt=>map.containerPointToLatLng(L.point(pt[0],pt[1])));
    const polygon = L.polygon(latlngs,{color:'red', fillOpacity:0.5}).addTo(drawnLayer);
    const area = turf.area(polygon.toGeoJSON());
    const areaHa = (area/10000).toFixed(2);
    polygonsCount++; areas.push(areaHa);
    let infoText = "Pol√≠gonos desenhados: " + polygonsCount + "<br>";
    areas.forEach((a,i)=>{ infoText += "Pol√≠gono " + (i+1) + ": " + a + " ha<br>"; });
    infoText += "<b>√Årea total: " + areas.reduce((sum, a) => sum + parseFloat(a), 0).toFixed(2) + " ha</b>";
    info.innerHTML = infoText;
    ctx.clearRect(0,0,canvas.width,canvas.height); points=[]; drawing = false; canvas.style.pointerEvents='none'; map.dragging.enable(); map.touchZoom.enable(); map.scrollWheelZoom.enable(); btnDraw.textContent='‚úèÔ∏è Desenhar';
}
canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('touchstart', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('touchmove', draw);
document.addEventListener('mouseup', endDrawing);
document.addEventListener('touchend', endDrawing);
window.addEventListener('resize',function(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; });

// --- Carregar Arquivos (KML/GeoJSON) ---
btnLoadKML.addEventListener('click', function() { inputLoadKML.click(); });
inputLoadKML.addEventListener('change', function(event){
    var file = event.target.files[0]; if(!file) return;
    var reader = new FileReader();
    reader.onload = function(e){
        var text = e.target.result;
        if(currentLoadedLayer) map.removeLayer(currentLoadedLayer);
        var filename = file.name.toLowerCase();
        if(filename.endsWith('.kml')) { currentLoadedLayer = omnivore.kml.parse(text).addTo(map); }
        else if(filename.endsWith('.geojson') || filename.endsWith('.json')) {
            var geojsonData = JSON.parse(text);
            currentLoadedLayer = L.geoJSON(geojsonData, { style: { color: strokeColorInput.value, fillColor: fillColorInput.value, fillOpacity: 0.5 } }).addTo(map);
        } else { customAlert("Formato n√£o suportado. Use KML ou GeoJSON."); return; }
        map.fitBounds(currentLoadedLayer.getBounds());
        btnKMLConfig.style.display = "block";
    };
    reader.readAsText(file);
    inputLoadKML.value = ''; // Limpa o input para permitir carregar o mesmo arquivo novamente
});

btnKMLConfig.onclick = function(){ kmlConfigPanel.style.display = kmlConfigPanel.style.display==='block'?'none':'block'; };
applyBtn.onclick = function(){
    if(!currentLoadedLayer) return;
    var strokeColor = strokeColorInput.value;
    var fillColor = noFillCheckbox.checked ? 'transparent' : fillColorInput.value;
    currentLoadedLayer.eachLayer(function(layer){
        if(layer.setStyle){ layer.setStyle({ color: strokeColor, fillColor: fillColor, fillOpacity: noFillCheckbox.checked ? 0 : 0.5 }); }
    });
    kmlConfigPanel.style.display = 'none';
};
btnDeleteKML.onclick = function(){ if(currentLoadedLayer){ map.removeLayer(currentLoadedLayer); currentLoadedLayer=null; btnKMLConfig.style.display='none'; kmlConfigPanel.style.display='none'; } };


// --- L√≥gica para Salvar ---
btnSave.onclick = function() {
    if (drawnLayer.getLayers().length === 0) {
        customAlert("N√£o h√° nada para salvar. Desenhe um pol√≠gono primeiro.");
        return;
    }
    dropdownMenu.classList.remove('show');
    formatModal.style.display = 'flex';
};

formatCancel.onclick = function() { formatModal.style.display = 'none'; };

formatOk.onclick = function() {
    var format = formatSelect.value; 
    formatModal.style.display = 'none';
    
    customPrompt("Digite o nome do arquivo:", "area_desenhada", function(fileNameInput){
        if(!fileNameInput) return; // Se o usu√°rio cancelar
        
        let content;
        let filename;
        let contentType;
        
        switch(format) {
            case "kml":
                let kmlContent = '<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>';
                drawnLayer.eachLayer(function(layer,index){
                    if(layer instanceof L.Polygon){
                        kmlContent += `<Placemark><name>Pol√≠gono ${index+1}</name><Polygon><outerBoundaryIs><LinearRing><coordinates>`;
                        // Garante que o primeiro e √∫ltimo ponto s√£o iguais para fechar o pol√≠gono
                        const latlngs = layer.getLatLngs()[0];
                        latlngs.forEach(function(latlng){ kmlContent += `${latlng.lng},${latlng.lat},0 `; });
                        kmlContent += `${latlngs[0].lng},${latlngs[0].lat},0 `; // Repete o primeiro ponto
                        kmlContent += `</coordinates></LinearRing></outerBoundaryIs></Polygon></Placemark>`;
                    }
                });
                kmlContent += '</Document></kml>';
                content = kmlContent;
                filename = fileNameInput;
                contentType = 'application/vnd.google-earth.kml+xml';
                break;
                
            case "geojson":
                const geojsonData = drawnLayer.toGeoJSON();
                content = JSON.stringify(geojsonData, null, 2); // O 2 √© para identa√ß√£o
                filename = fileNameInput ;
                contentType = 'application/json';
                break;
                
            case "csv":
                let csvContent = 'ID_Poligono,ID_Ponto,Latitude,Longitude\n';
                drawnLayer.eachLayer(function(layer, layerIndex){
                    if(layer instanceof L.Polygon){
                        const latlngs = layer.getLatLngs()[0];
                        latlngs.forEach(function(latlng, pointIndex){
                            csvContent += `${layerIndex+1},${pointIndex+1},${latlng.lat.toFixed(6)},${latlng.lng.toFixed(6)}\n`;
                        });
                    }
                });
                content = csvContent;
                filename = fileNameInput;
                contentType = 'text/csv;charset=utf-8;';
                break;
        }
        
        download(content, filename, contentType);
    });
};

// --- GPS ---
btnGps.onclick = function() {
    // Verifica se est√° no WebView do React Native
    if (window.ReactNativeWebView) {
        // Pede a localiza√ß√£o para o React Native
        window.ReactNativeWebView.postMessage('GET_LOCATION');
    } else {
        // Comportamento padr√£o para navegador web
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;
                map.setView([lat, lon], 15);
                L.marker([lat, lon]).addTo(map).bindPopup("Voc√™ est√° aqui!").openPopup();
            }, function() {
                customAlert("N√£o foi poss√≠vel obter sua localiza√ß√£o.");
            });
        } else {
            customAlert("Geolocaliza√ß√£o n√£o √© suportada por este navegador.");
        }
    }
};

// --- Fun√ß√µes Utilit√°rias ---
function customAlert(message, callback) {
    const modal = document.createElement('div');
    modal.className = 'custom-modal';
    modal.innerHTML = `<div class="custom-modal-content"><div>${message}</div><button id="okBtn">OK</button></div>`;
    document.body.appendChild(modal);
    modal.querySelector('#okBtn').onclick = function() { document.body.removeChild(modal); if(callback) callback(); };
}

function customPrompt(message, defaultValue, callback) {
    const modal = document.createElement('div');
    modal.className = 'custom-modal';
    modal.innerHTML = `
        <div class="custom-modal-content">
            <div>${message}</div>
            <input type="text" id="promptInput" value="${defaultValue||''}" />
            <div>
                <button id="cancelBtn">Cancelar</button>
                <button id="okBtn">OK</button>
            </div>
        </div>`;
    document.body.appendChild(modal);
    const input = modal.querySelector('#promptInput');
    modal.querySelector('#okBtn').onclick = function(){ document.body.removeChild(modal); callback(input.value); };
    modal.querySelector('#cancelBtn').onclick = function(){ document.body.removeChild(modal); callback(null); };
    input.focus();
}

function download(content, filename, contentType) {
    // Verifica se est√° rodando dentro de um WebView do React Native
    if (window.ReactNativeWebView) {
        // Envia os dados para o React Native em formato de string JSON
        const message = JSON.stringify({ content: content, filename: filename, contentType: contentType });
        window.ReactNativeWebView.postMessage(message);
    } else {
        // Comportamento padr√£o para navegador web
        const a = document.createElement('a');
        const file = new Blob([content], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        customAlert('Download iniciado no navegador.');
    }
}
</script>
</body>
</html>

